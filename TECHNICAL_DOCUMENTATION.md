# 七圣召唤游戏系统技术文档

## 1. 概述

本项目实现了一个完整的七圣召唤（Genshin Impact Card Game）游戏系统，包括游戏引擎、卡牌系统、用户认证、API接口和测试套件。系统采用Python Flask框架开发，支持单人本地游戏和多人在线对战（API层面）。

## 2. 系统架构

### 2.1 技术栈
- **后端**: Python 3.8+, Flask, Flask-JWT-Extended
- **数据库**: SQLite with SQLAlchemy
- **前端**: React (API compatible)
- **游戏引擎**: 自定义Python实现

### 2.2 项目结构
```
ys_qs/
├── api/                 # API路由
├── game_engine/         # 游戏引擎核心
│   ├── core.py          # 主游戏引擎
│   ├── element_reactions.py  # 元素反应系统
│   └── deck_validation.py    # 卡组验证系统
├── models/              # 数据模型
│   ├── game_models.py   # 游戏数据模型
│   └── enums.py         # 枚举定义
├── utils/               # 工具函数
└── tests/               # 测试文件
```

## 3. 游戏引擎功能详解

### 3.1 核心功能
1. **游戏阶段管理**:
   - 投掷阶段：重新获得8个元素骰子，可重投
   - 行动阶段：玩家轮流行动
   - 结束阶段：抽牌并处理状态效果

2. **角色系统**:
   - 生命值、充能（元素能量）管理
   - 角色附着元素
   - 装备系统（武器、圣遗物、天赋）
   - 状态效果

3. **行动系统**:
   - 快速行动与战斗行动区分
   - 技能使用（普通攻击、元素战技、元素爆发）
   - 角色切换
   - 卡牌打出
   - 元素调和
   - 回合结束

### 3.2 元素反应系统
实现了完整的七圣召唤元素反应机制：

- **增幅反应**:
  - 蒸发：水攻击火或火攻击水，伤害2倍
  - 融化：火攻击冰或冰攻击火，伤害2倍

- **物理反应**:
  - 超载：火+雷，造成2点额外伤害并强制切换角色
  - 感电：水+雷，造成1点伤害并对其他敌人造成1点穿透伤害
  - 超导：冰+雷，造成1点伤害并对其他敌人造成1点穿透伤害
  - 扩散：风与其他元素，对其他敌人造成对应元素伤害
  - 结晶：岩+其他元素，提供护盾
  - 燃烧：火+草，造成1点伤害并生成燃烧烈焰状态
  - 绽放：水+草，造成1点伤害并生成草原核状态
  - 原激化：雷+草，造成1点伤害并生成激化领域状态

### 3.3 战斗系统
- 伤害计算（含元素反应修正）
- 护盾机制
- 状态效果（如冻结、燃烧等）
- 角色击倒判定
- 免于被击倒机制

### 3.4 特殊游戏机制
- 重击机制（骰子数为偶数时普通攻击变成重击）
- 下落攻击机制（角色切换后下一次近战攻击变为下落攻击）
- 饱腹状态（料理效果限制）
- 秘传卡限制（每场对局只能使用一张）
- 复苏料理限制（每回合只能使用一张有复苏效果的料理）

## 4. API接口说明

### 4.1 用户认证
- `POST /auth/register` - 用户注册
- `POST /auth/login` - 用户登录
- `POST /auth/refresh` - 刷新令牌

### 4.2 卡牌管理
- `GET /cards` - 获取所有卡牌
- `GET /cards/characters` - 获取角色卡牌
- `GET /cards/events` - 获取事件卡牌
- `POST /cards/decks` - 创建卡组
- `PUT /cards/decks/<deck_id>` - 更新卡组
- `DELETE /cards/decks/<deck_id>` - 删除卡组
- `GET /cards/decks/<deck_id>` - 获取卡组详情
- `POST /cards/decks/validate` - 验证卡组

### 4.3 本地游戏
- `POST /api/local-game/create` - 创建本地游戏
- `POST /api/local-game/action` - 执行游戏行动
- `GET /api/local-game/state` - 获取游戏状态

## 5. 数据模型

### 5.1 游戏状态模型
- `GameState`: 游戏整体状态
- `PlayerState`: 玩家状态
- `CharacterCard`: 角色卡数据
- `Card`: 通用卡牌数据

### 5.2 枚举类型
- `ElementType`: 元素类型（火、水、雷、草、风、岩、冰、物理、万能等）
- `CardType`: 卡牌类型（角色牌、武器、圣遗物、天赋、支援牌、事件牌）
- `GamePhase`: 游戏阶段（投掷阶段、行动阶段、结束阶段）
- `PlayerAction`: 玩家行动类型
- `DamageType`: 伤害类型（物理伤害、元素伤害、治疗、穿透伤害）

## 6. 卡组验证系统

验证规则包括：
- 卡组总数必须为33张（3角色卡 + 30行动卡）
- 必须包含3张角色卡
- 除秘传卡外，同名行动卡最多2张
- 秘传卡每种只能1张
- 天赋卡必须对应已有角色
- 元素共鸣卡需要对应元素角色
- 国家卡需要对应国家角色

## 7. 测试覆盖

系统包含全面的测试套件：
- 元素反应系统测试
- 卡组验证系统测试
- 游戏引擎功能测试
- 特殊机制测试
- API端点测试

## 8. 部署说明

### 8.1 环境要求
- Python 3.8+
- Flask
- SQLAlchemy
- Flask-JWT-Extended

### 8.2 安装步骤
1. 安装依赖：`pip install -r requirements.txt`
2. 初始化数据库：`python init_db.py`
3. 导入卡牌数据：`python import_card_data.py`
4. 启动服务器：`python app.py`

### 8.3 配置选项
- 数据库连接字符串
- JWT密钥
- 调试模式设置

## 9. 扩展建议

1. **前端开发**: 实现React前端界面
2. **WebSocket**: 实现多人在线对战
3. **AI对手**: 开发AI对战系统
4. **游戏回放**: 添加游戏记录和回放功能
5. **统计数据**: 记录玩家对战数据

## 10. 总结

本项目成功实现了七圣召唤游戏的核心系统，包括完整的战斗机制、元素反应系统、卡组验证等。系统架构清晰，代码模块化程度高，具备良好的扩展性。游戏引擎能够正确处理各种游戏规则和特殊机制，API接口完整，测试覆盖全面，为构建完整的卡牌游戏平台奠定了坚实基础。