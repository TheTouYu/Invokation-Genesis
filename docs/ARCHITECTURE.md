# 七圣召唤架构设计文档

## 技术栈

### 后端
- **核心框架**: Python 3.8+ with Flask
- **数据库**: SQLite (开发)/PostgreSQL (生产)
- **ORM**: SQLAlchemy
- **认证**: JWT (JSON Web Tokens)
- **包管理**: uv (推荐) 或 pip
- **测试**: pytest

### 前端 (计划中)
- **框架**: React with TypeScript
- **状态管理**: Redux Toolkit
- **UI库**: Material-UI 或自定义组件
- **WebSocket**: socket.io-client
- **构建工具**: Vite 或 Webpack

### 开发工具
- **代码格式化**: black, isort
- **类型检查**: mypy
- **测试运行器**: pytest
- **API测试**: 内置HTML测试页面 + curl/Postman

## 系统架构

### 整体架构
系统采用前后端分离的架构模式，后端提供RESTful API，前端通过HTTP请求和WebSocket与后端交互。

```
┌─────────────┐    HTTP/HTTPS    ┌─────────────┐
│   Frontend  │◄────────────────►│   Backend   │
└─────────────┘                  └─────────────┘
                                       │
                                       ▼
                                ┌─────────────┐
                                │   Database  │
                                └─────────────┘
```

### 后端架构
后端采用分层架构模式，主要分为以下层次：

```
┌─────────────────────────────────────────────────┐
│                    API Layer                    │
│  (路由处理、请求验证、响应格式化)               │
└─────────────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│                 Service Layer                   │
│  (业务逻辑、游戏引擎、卡组验证)                 │
└─────────────────────────────────────────────────┘
                       │
                       ▼
┌─────────────────────────────────────────────────┐
│                 Data Layer                      │
│  (数据模型、数据库操作、卡牌数据)               │
└─────────────────────────────────────────────────┘
```

## 模块设计

### 1. API 模块 (`api/`)
负责处理所有HTTP请求，提供RESTful接口。

- **auth.py**: 用户认证相关API
- **cards.py**: 卡牌数据查询API
- **deck_builder/**: 卡组构建和管理API
- **local_game.py**: 本地游戏会话管理API

### 2. 游戏引擎模块 (`game_engine/`)
实现核心游戏逻辑和规则。

- **core.py**: 主游戏引擎，处理回合流程和行动
- **element_reactions.py**: 元素反应系统
- **deck_validation.py**: 卡组验证逻辑
- **action_processors.py**: 各种行动处理器

### 3. 数据模型模块 (`models/`)
定义所有数据结构和数据库模型。

- **enums.py**: 所有枚举类型（元素类型、卡牌类型等）
- **game_models.py**: 游戏数据类（角色、卡牌、状态等）
- **db_models.py**: 数据库模型（用户、卡组等）

### 4. 卡牌数据模块 (`card_data/`)
存储所有卡牌的JSON数据文件。

- **characters.json**: 角色牌数据
- **events.json**: 事件牌数据
- **equipments.json**: 装备牌数据
- **supports.json**: 支援牌数据

### 5. WebSocket 模块 (`socket_handlers/`)
处理实时游戏通信（多人游戏功能）。

- **game_room.py**: 游戏房间管理
- **matchmaking.py**: 匹配系统
- **spectator.py**: 观战功能

## 数据流设计

### 用户认证流程
```
1. 客户端 ──[POST /api/auth/register]──► 服务器
2. 服务器 ──[创建用户]──────────────► 数据库
3. 客户端 ──[POST /api/auth/login]───► 服务器
4. 服务器 ──[验证凭据]──────────────► 数据库
5. 服务器 ◄─[返回JWT令牌]───────────── 客户端
6. 客户端 ──[携带JWT的请求]──────────► 服务器
7. 服务器 ──[验证JWT]────────────────► 客户端
```

### 卡牌查询流程
```
1. 客户端 ──[GET /api/cards?params]──► 服务器
2. 服务器 ──[解析查询参数]────────────► 卡牌数据模块
3. 服务器 ◄─[返回过滤后的卡牌]───────── 客户端
```

### 游戏会话流程
```
1. 客户端 ──[POST /api/local-game/start]──► 服务器
2. 服务器 ──[创建游戏状态]────────────────► 游戏引擎
3. 服务器 ◄─[返回会话ID和初始状态]───────── 客户端
4. 客户端 ──[POST /api/local-game/{id}/action]──► 服务器
5. 服务器 ──[处理行动]──────────────────────► 游戏引擎
6. 服务器 ◄─[返回更新后的游戏状态]───────────── 客户端
```

## 数据库设计

### 核心实体关系图
```
┌───────────┐       ┌───────────┐       ┌───────────┐
│   User    │───────│   Deck    │───────│  Card     │
└───────────┘       └───────────┘       └───────────┘
     │
     │
     ▼
┌───────────┐
│ GameSession│
└───────────┘
```

### 主要表结构

#### users 表
- **id**: UUID (主键)
- **username**: VARCHAR (唯一)
- **password_hash**: VARCHAR
- **email**: VARCHAR
- **created_at**: DATETIME

#### decks 表
- **id**: UUID (主键)
- **user_id**: UUID (外键)
- **name**: VARCHAR
- **description**: TEXT
- **created_at**: DATETIME
- **updated_at**: DATETIME

#### deck_cards 表 (多对多关联表)
- **deck_id**: UUID (外键)
- **card_id**: VARCHAR (外键)
- **quantity**: INTEGER

#### game_sessions 表
- **id**: UUID (主键)
- **user_id**: UUID (外键)
- **deck_id**: UUID (外键)
- **opponent_type**: VARCHAR
- **game_state**: JSON
- **created_at**: DATETIME
- **updated_at**: DATETIME

## 扩展性设计

### 水平扩展
- **无状态API**: 所有API端点都是无状态的，便于水平扩展
- **会话管理**: 游戏会话状态存储在内存字典中（当前实现），未来可迁移到Redis
- **数据库连接池**: 使用SQLAlchemy连接池支持高并发

### 功能扩展
- **插件系统**: 游戏引擎设计为模块化，便于添加新卡牌类型和机制
- **规则配置**: 核心规则参数化，便于调整平衡性
- **多语言支持**: 卡牌数据设计支持多语言字段

### 性能优化
- **缓存策略**: 卡牌数据和常用查询结果缓存
- **分页查询**: 大数据集查询支持分页
- **索引优化**: 数据库关键字段建立索引

## 安全设计

### 认证与授权
- **JWT令牌**: 使用HS256算法签名，设置合理过期时间
- **密码安全**: 使用bcrypt哈希存储密码
- **权限控制**: 基于用户ID的资源访问控制

### 数据验证
- **输入验证**: 所有API端点验证输入参数
- **SQL注入防护**: 使用ORM参数化查询
- **XSS防护**: 前端负责输出编码（后端提供纯净数据）

### 安全头
- **CORS**: 配置适当的跨域策略
- **CSRF**: JWT认证天然免疫CSRF攻击
- **Content Security Policy**: 前端实现

## 部署架构

### 开发环境
- **单机部署**: Flask开发服务器 + SQLite数据库
- **热重载**: 代码修改自动重载
- **本地测试**: 内置API测试页面

### 生产环境 (建议)
- **Web服务器**: Gunicorn + Nginx
- **数据库**: PostgreSQL
- **会话存储**: Redis
- **静态文件**: CDN或Nginx直接服务
- **监控**: 日志聚合 + 健康检查端点

### 容器化 (可选)
- **Docker**: 单容器或多容器部署
- **Docker Compose**: 开发环境一键启动
- **Kubernetes**: 生产环境集群部署

## 未来架构演进

### 短期 (1-3个月)
- **前端开发**: 完成React前端实现
- **WebSocket集成**: 实现多人游戏功能
- **性能优化**: 添加缓存层

### 中期 (3-6个月)
- **AI对手**: 集成基础AI策略
- **匹配系统**: 实现玩家匹配功能
- **观战功能**: 支持观战和回放

### 长期 (6-12个月)
- **微服务化**: 将游戏引擎拆分为独立服务
- **分布式架构**: 支持大规模并发玩家
- **数据分析**: 添加游戏数据分析和统计